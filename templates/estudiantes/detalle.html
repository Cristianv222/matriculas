{% extends "base.html" %}
{% block title %}{{ estudiante.nombre_completo }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
        <div>
            <h1><i class="bi bi-person-badge me-2" style="color:var(--acento);"></i>{{ estudiante.nombre_completo }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'estudiantes:lista' %}">Estudiantes</a></li>
                    <li class="breadcrumb-item active">{{ estudiante.nombre_completo }}</li>
                </ol>
            </nav>
        </div>
        {% if request.user.es_secretaria %}
        <div class="d-flex gap-2">
            <a href="{% url 'estudiantes:editar' estudiante.pk %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-pencil me-1"></i>Editar
            </a>
            <a href="{% url 'matriculas:crear' %}?estudiante={{ estudiante.pk }}" class="btn btn-institucional btn-sm">
                <i class="bi bi-plus-circle me-1"></i>Nueva matrícula
            </a>
        </div>
        {% endif %}
    </div>
</div>

{# ── Fila superior: avatar + datos clave ──────────────────────────────────── #}
<div class="row g-3 mb-3">
    <div class="col-md-3 col-lg-2">
        <div class="card text-center" style="padding:1.25rem .75rem;">
            {% if estudiante.foto %}
                <img src="{{ estudiante.foto.url }}" alt="{{ estudiante.nombre_completo }}"
                     style="width:90px;height:90px;border-radius:50%;object-fit:cover;margin:0 auto 1rem;">
            {% else %}
                <div style="width:90px;height:90px;border-radius:50%;background:var(--azul-marino);
                            color:#fff;font-family:var(--fuente-display);font-size:2rem;font-weight:700;
                            display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;letter-spacing:.02em;">
                    {{ estudiante.nombres|slice:":1" }}{{ estudiante.apellidos|slice:":1" }}
                </div>
            {% endif %}
            <div style="font-family:var(--fuente-display);font-weight:700;font-size:.95rem;color:var(--azul-marino);line-height:1.2;">
                {{ estudiante.apellidos }}<br>
                <span style="font-weight:500;font-size:.85rem;">{{ estudiante.nombres }}</span>
            </div>
            {% if estudiante.edad %}
            <div style="margin-top:.4rem;font-size:.8rem;color:var(--gris-medio);">{{ estudiante.edad }} años</div>
            {% endif %}
            {% if estudiante.requiere_atencion_especial %}
            <span class="badge mt-2" style="background:#ffc107;color:#000;font-size:.7rem;">
                <i class="bi bi-exclamation-triangle me-1"></i>Atención especial
            </span>
            {% endif %}
        </div>
    </div>

    <div class="col-md-9 col-lg-10">
        <div class="row g-3 h-100">
            {# Stat: Cédula #}
            <div class="col-6 col-md-3">
                <div class="card text-center h-100" style="padding:.9rem;">
                    <div style="font-size:.68rem;text-transform:uppercase;letter-spacing:.07em;color:var(--gris-medio);">Cédula</div>
                    <div style="font-family:var(--fuente-display);font-weight:700;font-size:1.05rem;color:var(--azul-marino);margin-top:.25rem;">
                        {{ estudiante.cedula|default:"—" }}
                    </div>
                </div>
            </div>
            {# Stat: Género #}
            <div class="col-6 col-md-3">
                <div class="card text-center h-100" style="padding:.9rem;">
                    <div style="font-size:.68rem;text-transform:uppercase;letter-spacing:.07em;color:var(--gris-medio);">Género</div>
                    <div style="font-family:var(--fuente-display);font-weight:700;font-size:1.05rem;color:var(--azul-marino);margin-top:.25rem;">
                        {{ estudiante.get_genero_display }}
                    </div>
                </div>
            </div>
            {# Stat: Nacimiento #}
            <div class="col-6 col-md-3">
                <div class="card text-center h-100" style="padding:.9rem;">
                    <div style="font-size:.68rem;text-transform:uppercase;letter-spacing:.07em;color:var(--gris-medio);">Nacimiento</div>
                    <div style="font-family:var(--fuente-display);font-weight:700;font-size:1.05rem;color:var(--azul-marino);margin-top:.25rem;">
                        {{ estudiante.fecha_nacimiento|date:"d/m/Y" }}
                    </div>
                </div>
            </div>
            {# Stat: Matrículas #}
            <div class="col-6 col-md-3">
                <div class="card text-center h-100" style="padding:.9rem;">
                    <div style="font-size:.68rem;text-transform:uppercase;letter-spacing:.07em;color:var(--gris-medio);">Matrículas</div>
                    <div style="font-family:var(--fuente-display);font-weight:700;font-size:1.7rem;color:var(--azul-marino);margin-top:.1rem;">
                        {{ matriculas.count }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ── Contenido principal en tabs ──────────────────────────────────────────── #}
<ul class="nav nav-tabs mb-3" id="tabsEstudiante" role="tablist" style="border-bottom:2px solid var(--gris-borde);">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabPersonal" type="button">
            <i class="bi bi-person me-1"></i>Personal
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFamilia" type="button">
            <i class="bi bi-people me-1"></i>Familia
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMedico" type="button">
            <i class="bi bi-heart-pulse me-1"></i>Médico
            {% if estudiante.requiere_atencion_especial %}
            <span class="badge rounded-pill" style="background:#dc3545;font-size:.65rem;padding:.15rem .35rem;vertical-align:middle;">!</span>
            {% endif %}
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabProcedencia" type="button">
            <i class="bi bi-building me-1"></i>Procedencia
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMatriculas" type="button">
            <i class="bi bi-journal-check me-1"></i>Matrículas
            {% if matriculas %}
            <span class="badge rounded-pill ms-1" style="background:var(--azul-marino);font-size:.65rem;padding:.15rem .4rem;">{{ matriculas.count }}</span>
            {% endif %}
        </button>
    </li>
</ul>

<div class="tab-content">

    {# ────────────────────────── TAB: PERSONAL ────────────────────────────── #}
    <div class="tab-pane fade show active" id="tabPersonal">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-info-circle me-2"></i>Datos de identidad</div>
                    <div class="card-body">
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Apellidos" valor=estudiante.apellidos %}
                            {% include "estudiantes/_fila_dato.html" with label="Nombres" valor=estudiante.nombres %}
                            {% include "estudiantes/_fila_dato.html" with label="Cédula / Pasaporte" valor=estudiante.cedula %}
                            {% include "estudiantes/_fila_dato.html" with label="Fecha de nacimiento" valor=estudiante.fecha_nacimiento|date:"d/m/Y" %}
                            {% include "estudiantes/_fila_dato.html" with label="Edad" valor=estudiante.edad|stringformat:"s años" %}
                            {% include "estudiantes/_fila_dato.html" with label="Género" valor=estudiante.get_genero_display %}
                            {% include "estudiantes/_fila_dato.html" with label="Nacionalidad" valor=estudiante.nacionalidad %}
                            {% include "estudiantes/_fila_dato.html" with label="Etnia" valor=estudiante.get_etnia_display %}
                            {% include "estudiantes/_fila_dato.html" with label="Lugar de nacimiento" valor=estudiante.lugar_nacimiento %}
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-geo-alt me-2"></i>Dirección y contacto</div>
                    <div class="card-body">
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Ciudad" valor=estudiante.ciudad %}
                            {% include "estudiantes/_fila_dato.html" with label="Sector / Barrio" valor=estudiante.sector %}
                            {% include "estudiantes/_fila_dato.html" with label="Dirección" valor=estudiante.direccion %}
                            {% include "estudiantes/_fila_dato.html" with label="Teléfono emergencia" valor=estudiante.telefono_emergencia %}
                            {% include "estudiantes/_fila_dato.html" with label="Contacto emergencia" valor=estudiante.contacto_emergencia %}
                        </table>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header"><i class="bi bi-person-check me-2"></i>Representante legal</div>
                    <div class="card-body">
                        {% if estudiante.representante %}
                        <div class="d-flex align-items-center gap-3">
                            <div style="width:44px;height:44px;border-radius:50%;background:var(--azul-marino);color:#fff;
                                        font-family:var(--fuente-display);font-size:1.1rem;font-weight:700;
                                        display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                {{ estudiante.representante.first_name|slice:":1" }}{{ estudiante.representante.last_name|slice:":1" }}
                            </div>
                            <div>
                                <div style="font-weight:600;color:var(--azul-marino);">{{ estudiante.representante.get_full_name }}</div>
                                <div style="font-size:.8rem;color:var(--gris-medio);">{{ estudiante.relacion_representante }}</div>
                                {% if estudiante.representante.telefono %}
                                <div style="font-size:.8rem;color:var(--gris-medio);"><i class="bi bi-telephone me-1"></i>{{ estudiante.representante.telefono }}</div>
                                {% endif %}
                                {% if estudiante.representante.email %}
                                <div style="font-size:.8rem;color:var(--gris-medio);"><i class="bi bi-envelope me-1"></i>{{ estudiante.representante.email }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-dash-circle me-1"></i>Sin representante asignado</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if estudiante.observaciones_generales %}
            <div class="col-12">
                <div class="card" style="border-left:4px solid var(--acento);">
                    <div class="card-header"><i class="bi bi-chat-text me-2"></i>Observaciones generales</div>
                    <div class="card-body" style="font-size:.875rem;">{{ estudiante.observaciones_generales|linebreaksbr }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {# ────────────────────────── TAB: FAMILIA ─────────────────────────────── #}
    <div class="tab-pane fade" id="tabFamilia">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header" style="background:linear-gradient(90deg,var(--azul-marino) 0%,var(--azul-medio) 100%);color:#fff;">
                        <i class="bi bi-person me-2"></i>Datos del padre
                    </div>
                    <div class="card-body">
                        {% if estudiante.padre_nombres %}
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Nombres" valor=estudiante.padre_nombres %}
                            {% include "estudiantes/_fila_dato.html" with label="Cédula" valor=estudiante.padre_cedula %}
                            {% include "estudiantes/_fila_dato.html" with label="Ocupación" valor=estudiante.padre_ocupacion %}
                            {% include "estudiantes/_fila_dato.html" with label="Teléfono" valor=estudiante.padre_telefono %}
                            {% include "estudiantes/_fila_dato.html" with label="Email" valor=estudiante.padre_email %}
                            {% include "estudiantes/_fila_dato.html" with label="Estado civil" valor=estudiante.get_padre_estado_civil_display %}
                            {% include "estudiantes/_fila_dato.html" with label="Instrucción" valor=estudiante.get_padre_instruccion_display %}
                        </table>
                        {% else %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-dash-circle me-1"></i>Sin datos registrados</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header" style="background:linear-gradient(90deg,#6c3483 0%,#9b59b6 100%);color:#fff;">
                        <i class="bi bi-person me-2"></i>Datos de la madre
                    </div>
                    <div class="card-body">
                        {% if estudiante.madre_nombres %}
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Nombres" valor=estudiante.madre_nombres %}
                            {% include "estudiantes/_fila_dato.html" with label="Cédula" valor=estudiante.madre_cedula %}
                            {% include "estudiantes/_fila_dato.html" with label="Ocupación" valor=estudiante.madre_ocupacion %}
                            {% include "estudiantes/_fila_dato.html" with label="Teléfono" valor=estudiante.madre_telefono %}
                            {% include "estudiantes/_fila_dato.html" with label="Email" valor=estudiante.madre_email %}
                            {% include "estudiantes/_fila_dato.html" with label="Estado civil" valor=estudiante.get_madre_estado_civil_display %}
                            {% include "estudiantes/_fila_dato.html" with label="Instrucción" valor=estudiante.get_madre_instruccion_display %}
                        </table>
                        {% else %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-dash-circle me-1"></i>Sin datos registrados</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ────────────────────────── TAB: MÉDICO ──────────────────────────────── #}
    <div class="tab-pane fade" id="tabMedico">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-heart-pulse me-2"></i>Datos médicos</div>
                    <div class="card-body">
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Tipo de sangre" valor=estudiante.tipo_sangre %}
                            {% include "estudiantes/_fila_dato.html" with label="Seguro médico" valor=estudiante.seguro_medico %}
                            {% include "estudiantes/_fila_dato.html" with label="Médico tratante" valor=estudiante.medico_tratante %}
                        </table>

                        {% if estudiante.alergias %}
                        <div class="mt-3" style="background:#fff3cd;border-left:4px solid #ffc107;padding:.65rem .85rem;border-radius:0 4px 4px 0;font-size:.85rem;">
                            <div style="font-weight:600;margin-bottom:.25rem;"><i class="bi bi-exclamation-triangle me-1 text-warning"></i>Alergias</div>
                            {{ estudiante.alergias|linebreaksbr }}
                        </div>
                        {% endif %}

                        {% if estudiante.enfermedades_cronicas %}
                        <div class="mt-3" style="background:#f8d7da;border-left:4px solid #dc3545;padding:.65rem .85rem;border-radius:0 4px 4px 0;font-size:.85rem;">
                            <div style="font-weight:600;margin-bottom:.25rem;"><i class="bi bi-clipboard-heart me-1 text-danger"></i>Enfermedades crónicas</div>
                            {{ estudiante.enfermedades_cronicas|linebreaksbr }}
                        </div>
                        {% endif %}

                        {% if estudiante.medicacion_actual %}
                        <div class="mt-3" style="background:#d1ecf1;border-left:4px solid #17a2b8;padding:.65rem .85rem;border-radius:0 4px 4px 0;font-size:.85rem;">
                            <div style="font-weight:600;margin-bottom:.25rem;"><i class="bi bi-capsule me-1"></i>Medicación actual</div>
                            {{ estudiante.medicacion_actual|linebreaksbr }}
                        </div>
                        {% endif %}

                        {% if not estudiante.tiene_datos_medicos %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-check-circle me-1 text-success"></i>Sin condiciones médicas registradas</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card {% if estudiante.tiene_discapacidad %}border-warning{% endif %}">
                    <div class="card-header" style="{% if estudiante.tiene_discapacidad %}background:#ffc107;color:#000;{% endif %}">
                        <i class="bi bi-universal-access me-2"></i>Discapacidad / NEE
                    </div>
                    <div class="card-body">
                        {% if estudiante.tiene_discapacidad %}
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            <tr>
                                <td style="padding:.35rem 0;color:var(--gris-medio);width:40%;">Tipo</td>
                                <td style="padding:.35rem 0;font-weight:500;">{{ estudiante.tipo_discapacidad }}</td>
                            </tr>
                            {% if estudiante.porcentaje_discapacidad %}
                            <tr>
                                <td style="padding:.35rem 0;color:var(--gris-medio);">Porcentaje</td>
                                <td style="padding:.35rem 0;font-weight:500;">{{ estudiante.porcentaje_discapacidad }}%</td>
                            </tr>
                            {% endif %}
                            {% if estudiante.numero_conadis %}
                            <tr>
                                <td style="padding:.35rem 0;color:var(--gris-medio);">N° CONADIS</td>
                                <td style="padding:.35rem 0;font-weight:500;">{{ estudiante.numero_conadis }}</td>
                            </tr>
                            {% endif %}
                        </table>
                        {% if estudiante.necesidades_especiales %}
                        <div class="mt-3" style="background:#fff3cd;padding:.65rem .85rem;border-radius:4px;font-size:.85rem;">
                            <div style="font-weight:600;margin-bottom:.25rem;">Necesidades educativas especiales</div>
                            {{ estudiante.necesidades_especiales|linebreaksbr }}
                        </div>
                        {% endif %}
                        {% else %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-check-circle me-1 text-success"></i>No registra discapacidad</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ────────────────────────── TAB: PROCEDENCIA ─────────────────────────── #}
    <div class="tab-pane fade" id="tabProcedencia">
        <div class="row g-3 justify-content-center">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header"><i class="bi bi-building me-2"></i>Institución educativa anterior</div>
                    <div class="card-body">
                        {% if estudiante.institucion_anterior %}
                        <table style="width:100%;font-size:.875rem;border-collapse:collapse;">
                            {% include "estudiantes/_fila_dato.html" with label="Institución" valor=estudiante.institucion_anterior %}
                            {% include "estudiantes/_fila_dato.html" with label="Código AMIE" valor=estudiante.amie_anterior %}
                            {% include "estudiantes/_fila_dato.html" with label="Último grado aprobado" valor=estudiante.grado_anterior %}
                            {% include "estudiantes/_fila_dato.html" with label="Año lectivo" valor=estudiante.anio_anterior %}
                            {% if estudiante.promedio_anterior %}
                            <tr>
                                <td style="padding:.35rem 0;color:var(--gris-medio);width:40%;">Promedio final</td>
                                <td style="padding:.35rem 0;">
                                    <span style="font-family:var(--fuente-display);font-weight:700;font-size:1.1rem;
                                        color:{% if estudiante.promedio_anterior >= 7 %}#198754{% else %}#dc3545{% endif %};">
                                        {{ estudiante.promedio_anterior }}
                                    </span>
                                    <span style="font-size:.75rem;color:var(--gris-medio);"> / 10</span>
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                        {% if estudiante.motivo_cambio %}
                        <div class="mt-3" style="background:var(--gris-claro);padding:.65rem .85rem;border-radius:4px;font-size:.85rem;">
                            <div style="font-weight:600;margin-bottom:.25rem;color:var(--gris-medio);">Motivo de cambio</div>
                            {{ estudiante.motivo_cambio|linebreaksbr }}
                        </div>
                        {% endif %}
                        {% else %}
                        <p style="color:var(--gris-medio);font-size:.875rem;margin:0;"><i class="bi bi-info-circle me-1"></i>Estudiante nuevo — sin procedencia registrada</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ────────────────────────── TAB: MATRÍCULAS ──────────────────────────── #}
    <div class="tab-pane fade" id="tabMatriculas">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-journal-check me-2"></i>Historial de matrículas</span>
                {% if request.user.es_secretaria %}
                <a href="{% url 'matriculas:crear' %}?estudiante={{ estudiante.pk }}" class="btn btn-institucional btn-sm">
                    <i class="bi bi-plus me-1"></i>Nueva matrícula
                </a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if matriculas %}
                <div class="table-responsive">
                    <table class="table table-hover" style="margin:0;font-size:.875rem;">
                        <thead>
                            <tr style="background:var(--azul-marino);color:#fff;">
                                <th style="padding:.6rem 1rem;font-weight:500;">Período</th>
                                <th style="padding:.6rem 1rem;font-weight:500;">Paralelo</th>
                                <th style="padding:.6rem 1rem;font-weight:500;">Jornada</th>
                                <th style="padding:.6rem 1rem;font-weight:500;">Fecha solicitud</th>
                                <th style="padding:.6rem 1rem;font-weight:500;">Estado</th>
                                <th style="padding:.6rem 1rem;font-weight:500;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in matriculas %}
                            <tr>
                                <td style="padding:.6rem 1rem;">{{ m.paralelo.periodo.nombre }}</td>
                                <td style="padding:.6rem 1rem;">
                                    {{ m.paralelo.nivel.nombre }} — {{ m.paralelo.nombre }}
                                </td>
                                <td style="padding:.6rem 1rem;">{{ m.paralelo.get_jornada_display|default:"—" }}</td>
                                <td style="padding:.6rem 1rem;">{{ m.fecha_solicitud|date:"d/m/Y" }}</td>
                                <td style="padding:.6rem 1rem;">
                                    {% if m.estado == 'APROBADA' %}
                                        <span class="badge" style="background:#198754;">Aprobada</span>
                                    {% elif m.estado == 'PENDIENTE' %}
                                        <span class="badge" style="background:#ffc107;color:#000;">Pendiente</span>
                                    {% elif m.estado == 'EN_REVISION' %}
                                        <span class="badge" style="background:#0dcaf0;color:#000;">En revisión</span>
                                    {% elif m.estado == 'RECHAZADA' %}
                                        <span class="badge" style="background:#dc3545;">Rechazada</span>
                                    {% elif m.estado == 'RETIRADA' %}
                                        <span class="badge" style="background:#6c757d;">Retirada</span>
                                    {% else %}
                                        <span class="badge" style="background:#6c757d;">{{ m.estado }}</span>
                                    {% endif %}
                                </td>
                                <td style="padding:.6rem 1rem;text-align:right;">
                                    <a href="{% url 'matriculas:detalle' m.pk %}" class="btn btn-outline-secondary btn-sm" style="padding:.2rem .5rem;font-size:.75rem;">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="padding:2.5rem;text-align:center;color:var(--gris-medio);">
                    <i class="bi bi-journal-x" style="font-size:2.5rem;display:block;margin-bottom:.75rem;opacity:.35;"></i>
                    Este estudiante no tiene matrículas registradas aún.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endblock %}