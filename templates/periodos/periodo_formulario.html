{% extends "base.html" %}
{% block title %}{{ titulo|default:"Período Académico" }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h1><i class="bi bi-calendar-plus me-2" style="color:var(--acento);"></i>{{ titulo|default:"Período Académico" }}</h1>
            <nav aria-label="breadcrumb"><ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'periodos:periodo-lista' %}">Períodos</a></li>
                <li class="breadcrumb-item active">{{ titulo }}</li>
            </ol></nav>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <form method="post"
              action="{% if form.instance.pk %}{% url 'periodos:periodo-editar' form.instance.pk %}{% else %}{% url 'periodos:periodo-crear' %}{% endif %}"
              novalidate>
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-info-circle me-2"></i>Datos generales</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Nombre del período <span class="text-danger">*</span></label>
                            {{ form.nombre }}
                            {% if form.nombre.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.nombre.errors|first }}</div>{% endif %}
                            <div style="font-size:.75rem;color:var(--gris-medio);margin-top:.25rem;">Ej: 2024-2025 Sierra</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Régimen</label>
                            {{ form.regimen }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Inicio de clases <span class="text-danger">*</span></label>
                            {{ form.fecha_inicio }}
                            {% if form.fecha_inicio.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_inicio.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fin del año lectivo <span class="text-danger">*</span></label>
                            {{ form.fecha_fin }}
                            {% if form.fecha_fin.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_fin.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                {{ form.es_activo }}
                                <label class="form-check-label" for="{{ form.es_activo.id_for_label }}" style="font-size:.875rem;">
                                    <strong>Período activo</strong>
                                    <span style="font-size:.78rem;color:var(--gris-medio);display:block;">
                                        Al activar este período, se desactivarán los demás automáticamente.
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-calendar-check me-2"></i>Ventana de matrículas</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Inicio de matrículas <span class="text-danger">*</span></label>
                            {{ form.fecha_inicio_matriculas }}
                            {% if form.fecha_inicio_matriculas.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_inicio_matriculas.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fin de matrículas <span class="text-danger">*</span></label>
                            {{ form.fecha_fin_matriculas }}
                            {% if form.fecha_fin_matriculas.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_fin_matriculas.errors|first }}</div>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <div class="form-check mb-0">
                        {{ form.permite_matricula_extra }}
                        <label class="form-check-label" for="{{ form.permite_matricula_extra.id_for_label }}" style="font-size:.9rem;font-weight:600;">
                            <i class="bi bi-star me-1"></i>Habilitar matrículas extraordinarias
                        </label>
                    </div>
                </div>
                <div class="card-body" id="bloqueExtra" style="{% if not form.instance.permite_matricula_extra %}display:none;{% endif %}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Inicio extraordinarias</label>
                            {{ form.fecha_inicio_extra }}
                            {% if form.fecha_inicio_extra.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_inicio_extra.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fin extraordinarias</label>
                            {{ form.fecha_fin_extra }}
                            {% if form.fecha_fin_extra.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.fecha_fin_extra.errors|first }}</div>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header"><i class="bi bi-chat-text me-2"></i>Observaciones</div>
                <div class="card-body">
                    {{ form.observaciones }}
                </div>
            </div>

            {% if form.non_field_errors %}
            <div style="border-left:4px solid #dc3545;background:#f8d7da;color:#842029;padding:.65rem 1rem;border-radius:4px;font-size:.85rem;margin-bottom:1rem;">
                {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
            </div>
            {% endif %}

            <div class="d-flex gap-2 justify-content-end">
                <a href="{% url 'periodos:periodo-lista' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x me-1"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-institucional">
                    <i class="bi bi-check2 me-1"></i>{{ accion|default:"Guardar" }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chk = document.getElementById('{{ form.permite_matricula_extra.id_for_label }}');
const blq = document.getElementById('bloqueExtra');
if (chk) {
    chk.addEventListener('change', () => {
        blq.style.display = chk.checked ? '' : 'none';
    });
}
</script>
{% endblock %}