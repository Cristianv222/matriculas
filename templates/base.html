<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ SCHOOL_NAME }}{% endblock %} — Sistema de Matrículas</title>

    <!-- Google Fonts: Lora (display) + Source Sans 3 (body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    {% load static %}
    <style>
        /* ─── Variables ───────────────────────────────────────── */
        :root {
            --azul-marino:   #1a2e4a;
            --azul-medio:    #24487a;
            --azul-claro:    #2e5fa3;
            --acento:        #c8a84b;   /* dorado institucional */
            --acento-hover:  #b5943a;
            --gris-oscuro:   #343a40;
            --gris-medio:    #6c757d;
            --gris-claro:    #e9ecef;
            --gris-borde:    #dee2e6;
            --blanco:        #ffffff;
            --fondo:         #f4f5f7;
            --sidebar-w:     260px;
            --navbar-h:      60px;
            --fuente-display: 'Lora', Georgia, serif;
            --fuente-body:    'Source Sans 3', 'Segoe UI', sans-serif;
            --radio:          4px;
            --sombra:         0 1px 4px rgba(0,0,0,.10);
            --sombra-md:      0 3px 12px rgba(0,0,0,.13);
        }

        /* ─── Reset y base ────────────────────────────────────── */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--fuente-body);
            font-size: 15px;
            font-weight: 400;
            color: var(--gris-oscuro);
            background: var(--fondo);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, h4, h5, h6,
        .font-display {
            font-family: var(--fuente-display);
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* ─── Navbar principal ────────────────────────────────── */
        .navbar-institucional {
            background: var(--azul-marino);
            height: var(--navbar-h);
            padding: 0 1.25rem;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1050;
            box-shadow: 0 2px 6px rgba(0,0,0,.25);
        }

        .navbar-institucional .navbar-brand {
            font-family: var(--fuente-display);
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--blanco) !important;
            letter-spacing: .01em;
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .navbar-institucional .navbar-brand .brand-icon {
            width: 34px; height: 34px;
            background: var(--acento);
            border-radius: var(--radio);
            display: flex; align-items: center; justify-content: center;
            font-size: .95rem;
            flex-shrink: 0;
        }

        .navbar-institucional .nav-link {
            color: rgba(255,255,255,.80) !important;
            font-size: .875rem;
            font-weight: 500;
            padding: .35rem .75rem !important;
            border-radius: var(--radio);
            transition: color .15s, background .15s;
        }
        .navbar-institucional .nav-link:hover,
        .navbar-institucional .nav-link.active {
            color: var(--blanco) !important;
            background: rgba(255,255,255,.10);
        }

        /* Avatar en navbar */
        .nav-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--azul-claro);
            border: 2px solid rgba(255,255,255,.3);
            display: flex; align-items: center; justify-content: center;
            font-size: .75rem; font-weight: 600;
            color: var(--blanco);
            overflow: hidden;
        }
        .nav-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* ─── Sidebar ─────────────────────────────────────────── */
        .sidebar {
            position: fixed;
            top: var(--navbar-h);
            left: 0;
            width: var(--sidebar-w);
            height: calc(100vh - var(--navbar-h));
            background: var(--blanco);
            border-right: 1px solid var(--gris-borde);
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1040;
            display: flex;
            flex-direction: column;
            transition: transform .25s ease;
        }

        .sidebar-section {
            padding: 1.25rem 1rem .5rem;
        }

        .sidebar-section-label {
            font-size: .68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--gris-medio);
            padding: 0 .5rem;
            margin-bottom: .35rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .48rem .75rem;
            border-radius: var(--radio);
            color: var(--gris-oscuro);
            text-decoration: none;
            font-size: .875rem;
            font-weight: 400;
            transition: background .12s, color .12s;
            margin-bottom: 2px;
        }

        .sidebar-link i {
            font-size: 1rem;
            color: var(--gris-medio);
            flex-shrink: 0;
            transition: color .12s;
        }

        .sidebar-link:hover {
            background: var(--gris-claro);
            color: var(--azul-marino);
        }
        .sidebar-link:hover i { color: var(--azul-claro); }

        .sidebar-link.active {
            background: #e8eff8;
            color: var(--azul-claro);
            font-weight: 600;
        }
        .sidebar-link.active i { color: var(--azul-claro); }

        .sidebar-link .badge-sidebar {
            margin-left: auto;
            font-size: .65rem;
            background: var(--azul-claro);
            color: var(--blanco);
            padding: .15rem .45rem;
            border-radius: 10px;
        }

        /* Panel de usuario al final del sidebar */
        .sidebar-user {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid var(--gris-borde);
        }

        .sidebar-user-card {
            display: flex;
            align-items: center;
            gap: .65rem;
            padding: .6rem .75rem;
            border-radius: var(--radio);
            background: var(--fondo);
        }

        .sidebar-user-avatar {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--azul-marino);
            display: flex; align-items: center; justify-content: center;
            color: var(--blanco);
            font-size: .75rem; font-weight: 700;
            flex-shrink: 0;
            overflow: hidden;
        }
        .sidebar-user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .sidebar-user-name {
            font-size: .82rem;
            font-weight: 600;
            color: var(--gris-oscuro);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-user-role {
            font-size: .72rem;
            color: var(--gris-medio);
        }

        /* ─── Contenido principal ─────────────────────────────── */
        .page-wrapper {
            margin-top: var(--navbar-h);
            margin-left: var(--sidebar-w);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - var(--navbar-h));
        }

        /* Sin sidebar (login, registro) */
        .page-wrapper.no-sidebar {
            margin-left: 0;
        }

        .page-content {
            flex: 1;
            padding: 1.75rem 2rem;
        }

        /* ─── Page header ─────────────────────────────────────── */
        .page-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gris-borde);
        }

        .page-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--azul-marino);
            margin: 0;
        }

        .page-header .breadcrumb {
            margin: 0;
            padding: 0;
            font-size: .8rem;
            background: none;
        }
        .page-header .breadcrumb-item + .breadcrumb-item::before { color: var(--gris-medio); }

        /* ─── Alertas / mensajes ──────────────────────────────── */
        .alertas-container {
            padding: .75rem 2rem 0;
        }

        .alert {
            border: none;
            border-left: 4px solid;
            border-radius: var(--radio);
            font-size: .875rem;
            padding: .7rem 1rem;
        }
        .alert-success { border-color: #198754; background: #d1e7dd; color: #0f5132; }
        .alert-danger  { border-color: #dc3545; background: #f8d7da; color: #842029; }
        .alert-warning { border-color: #c8a84b; background: #fff3cd; color: #664d03; }
        .alert-info    { border-color: #0dcaf0; background: #cff4fc; color: #055160; }

        /* ─── Cards ───────────────────────────────────────────── */
        .card {
            border: 1px solid var(--gris-borde);
            border-radius: var(--radio);
            box-shadow: var(--sombra);
            background: var(--blanco);
        }

        .card-header {
            background: var(--blanco);
            border-bottom: 1px solid var(--gris-borde);
            padding: .9rem 1.25rem;
            font-family: var(--fuente-display);
            font-size: .95rem;
            font-weight: 600;
            color: var(--azul-marino);
        }

        /* ─── Stat cards ──────────────────────────────────────── */
        .stat-card {
            background: var(--blanco);
            border: 1px solid var(--gris-borde);
            border-radius: var(--radio);
            padding: 1.25rem 1.5rem;
            box-shadow: var(--sombra);
        }

        .stat-card .stat-label {
            font-size: .78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--gris-medio);
        }

        .stat-card .stat-value {
            font-family: var(--fuente-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--azul-marino);
            line-height: 1.1;
        }

        .stat-card .stat-icon {
            width: 44px; height: 44px;
            border-radius: var(--radio);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }

        /* ─── Badges de estado ────────────────────────────────── */
        .badge-estado {
            font-size: .72rem;
            font-weight: 600;
            padding: .28rem .65rem;
            border-radius: 3px;
            letter-spacing: .03em;
            text-transform: uppercase;
        }
        .badge-pendiente   { background: #fff3cd; color: #7a5800; }
        .badge-revision    { background: #cff4fc; color: #055160; }
        .badge-aprobada    { background: #d1e7dd; color: #0a3622; }
        .badge-rechazada   { background: #f8d7da; color: #58151c; }
        .badge-anulada     { background: #e2e3e5; color: #41464b; }

        /* ─── Tablas ──────────────────────────────────────────── */
        .tabla-institucional {
            font-size: .875rem;
        }
        .tabla-institucional thead th {
            background: var(--azul-marino);
            color: var(--blanco);
            font-family: var(--fuente-body);
            font-size: .75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .07em;
            border: none;
            padding: .7rem 1rem;
        }
        .tabla-institucional tbody tr:hover { background: #f0f4f9; }
        .tabla-institucional tbody td {
            vertical-align: middle;
            padding: .65rem 1rem;
            border-color: var(--gris-borde);
            color: var(--gris-oscuro);
        }

        /* ─── Formularios ─────────────────────────────────────── */
        .form-label {
            font-size: .82rem;
            font-weight: 600;
            color: var(--gris-oscuro);
            margin-bottom: .35rem;
        }

        .form-control, .form-select {
            border: 1px solid #ced4da;
            border-radius: var(--radio);
            font-size: .875rem;
            padding: .5rem .75rem;
            transition: border-color .15s, box-shadow .15s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--azul-claro);
            box-shadow: 0 0 0 3px rgba(46, 95, 163, .12);
        }

        .form-section-title {
            font-family: var(--fuente-display);
            font-size: .95rem;
            font-weight: 600;
            color: var(--azul-marino);
            padding-bottom: .5rem;
            border-bottom: 2px solid var(--acento);
            margin-bottom: 1.25rem;
        }

        /* ─── Botones ─────────────────────────────────────────── */
        .btn {
            font-size: .875rem;
            font-weight: 500;
            border-radius: var(--radio);
            padding: .45rem 1.1rem;
        }

        .btn-primary {
            background: var(--azul-claro);
            border-color: var(--azul-claro);
        }
        .btn-primary:hover { background: var(--azul-medio); border-color: var(--azul-medio); }

        .btn-institucional {
            background: var(--azul-marino);
            border-color: var(--azul-marino);
            color: var(--blanco);
        }
        .btn-institucional:hover {
            background: var(--azul-medio);
            border-color: var(--azul-medio);
            color: var(--blanco);
        }

        .btn-acento {
            background: var(--acento);
            border-color: var(--acento);
            color: var(--blanco);
        }
        .btn-acento:hover { background: var(--acento-hover); border-color: var(--acento-hover); color: var(--blanco); }

        /* ─── Paginación ──────────────────────────────────────── */
        .pagination .page-link {
            font-size: .82rem;
            color: var(--azul-claro);
            border-color: var(--gris-borde);
        }
        .pagination .page-item.active .page-link {
            background: var(--azul-marino);
            border-color: var(--azul-marino);
        }

        /* ─── Footer ──────────────────────────────────────────── */
        .footer-institucional {
            background: var(--blanco);
            border-top: 1px solid var(--gris-borde);
            padding: .75rem 2rem;
        }
        .footer-institucional small { color: var(--gris-medio); font-size: .78rem; }

        /* ─── Toggle sidebar mobile ───────────────────────────── */
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--blanco);
            font-size: 1.2rem;
            padding: .25rem .5rem;
            cursor: pointer;
        }

        /* ─── Responsive ──────────────────────────────────────── */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
                box-shadow: var(--sombra-md);
            }
            .page-wrapper {
                margin-left: 0;
            }
            .page-content {
                padding: 1.25rem 1rem;
            }
            .sidebar-toggle { display: block; }
            .alertas-container { padding: .75rem 1rem 0; }
        }

        /* ─── Overlay para mobile ─────────────────────────────── */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.35);
            z-index: 1039;
        }
        .sidebar-overlay.show { display: block; }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>

{# ─── Navbar ──────────────────────────────────────────────────────────── #}
<nav class="navbar-institucional d-flex align-items-center">

    <button class="sidebar-toggle me-2" id="sidebarToggle" aria-label="Menú">
        <i class="bi bi-list"></i>
    </button>

    <a class="navbar-brand" href="{% url 'core:home' %}">
        <span class="brand-icon"><i class="bi bi-mortarboard-fill"></i></span>
        <span class="d-none d-sm-inline">{{ SCHOOL_NAME }}</span>
    </a>

    <div class="ms-auto d-flex align-items-center gap-2">
        {% if user.is_authenticated %}
        {# Notificaciones #}
        <a href="{% url 'notificaciones:lista' %}" class="nav-link position-relative" title="Notificaciones">
            <i class="bi bi-bell" style="font-size:1.1rem; color:rgba(255,255,255,.8);"></i>
        </a>

        {# Dropdown usuario #}
        <div class="dropdown">
            <button class="btn p-0 d-flex align-items-center gap-2 border-0 bg-transparent"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <div class="nav-avatar">
                    {% if user.foto %}
                        <img src="{{ user.foto.url }}" alt="">
                    {% else %}
                        {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                    {% endif %}
                </div>
                <span class="text-white d-none d-md-inline" style="font-size:.85rem; font-weight:500;">
                    {{ user.get_full_name|default:user.username }}
                </span>
                <i class="bi bi-chevron-down text-white-50" style="font-size:.7rem;"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end mt-1" style="font-size:.875rem; min-width:200px;">
                <li class="px-3 py-2 border-bottom">
                    <div style="font-size:.82rem; font-weight:600; color:var(--azul-marino);">
                        {{ user.get_full_name|default:user.username }}
                    </div>
                    <div style="font-size:.75rem; color:var(--gris-medio);">{{ user.get_rol_display }}</div>
                </li>
                <li>
                    <a class="dropdown-item" href="{% url 'usuarios:perfil' %}">
                        <i class="bi bi-person me-2"></i>Mi Perfil
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{% url 'usuarios:cambio-password' %}">
                        <i class="bi bi-shield-lock me-2"></i>Cambiar contraseña
                    </a>
                </li>
                <li><hr class="dropdown-divider my-1"></li>
                <li>
                    <form method="post" action="{% url 'usuarios:logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item text-danger">
                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        {% else %}
        <a href="{% url 'usuarios:login' %}" class="btn btn-sm"
           style="background:var(--acento);color:#fff;border:none;">
            Iniciar sesión
        </a>
        {% endif %}
    </div>
</nav>

{# ─── Overlay mobile ──────────────────────────────────────────────────── #}
<div class="sidebar-overlay" id="sidebarOverlay"></div>

{# ─── Sidebar ─────────────────────────────────────────────────────────── #}
{% if user.is_authenticated %}
<aside class="sidebar" id="sidebar">
    {% block sidebar %}
        {% if user.es_secretaria or user.es_admin %}
            {% include "partials/sidebar_admin.html" %}
        {% else %}
            {% include "partials/sidebar_representante.html" %}
        {% endif %}
    {% endblock %}

    {# Panel usuario al pie del sidebar #}
    <div class="sidebar-user">
        <div class="sidebar-user-card">
            <div class="sidebar-user-avatar">
                {% if user.foto %}
                    <img src="{{ user.foto.url }}" alt="">
                {% else %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% endif %}
            </div>
            <div class="overflow-hidden">
                <div class="sidebar-user-name">{{ user.nombre_completo }}</div>
                <div class="sidebar-user-role">{{ user.get_rol_display }}</div>
            </div>
        </div>
    </div>
</aside>
{% endif %}

{# ─── Wrapper principal ───────────────────────────────────────────────── #}
<div class="page-wrapper {% if not user.is_authenticated %}no-sidebar{% endif %}">

    {# Mensajes del sistema #}
    {% if messages %}
    <div class="alertas-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'danger' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# Contenido #}
    <main class="page-content">
        {% block content %}{% endblock %}
    </main>

    {# Footer #}
    <footer class="footer-institucional">
        <small>
            <strong>{{ SCHOOL_NAME }}</strong>
            &nbsp;·&nbsp; {{ SCHOOL_CITY }}, {{ SCHOOL_PROVINCE }}
            &nbsp;·&nbsp; AMIE: {{ SCHOOL_AMIE }}
            &nbsp;·&nbsp; &copy; {% now "Y" %}
        </small>
    </footer>

</div>{# /page-wrapper #}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ── Toggle sidebar en mobile ── */
    const sidebar        = document.getElementById('sidebar');
    const sidebarToggle  = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function openSidebar() {
        sidebar?.classList.add('show');
        sidebarOverlay?.classList.add('show');
    }
    function closeSidebar() {
        sidebar?.classList.remove('show');
        sidebarOverlay?.classList.remove('show');
    }

    sidebarToggle?.addEventListener('click', () => {
        sidebar?.classList.contains('show') ? closeSidebar() : openSidebar();
    });
    sidebarOverlay?.addEventListener('click', closeSidebar);

    /* ── Marcar enlace activo en sidebar ── */
    const currentPath = window.location.pathname;
    document.querySelectorAll('.sidebar-link').forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
</script>
{% block extra_js %}{% endblock %}
</body>
</html>