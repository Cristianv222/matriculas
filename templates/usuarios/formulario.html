{% extends "base.html" %}
{% block title %}{{ titulo|default:"Usuario" }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <h1><i class="bi bi-person-badge me-2" style="color:var(--acento);"></i>{{ titulo|default:"Usuario" }}</h1>
            <nav aria-label="breadcrumb"><ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'usuarios:lista' %}">Usuarios</a></li>
                <li class="breadcrumb-item active">{{ titulo }}</li>
            </ol></nav>
        </div>
    </div>
</div>

<div class="row g-4">

    {# Columna principal: formulario #}
    <div class="col-lg-8">
        <form method="post" enctype="multipart/form-data" action="{% if form.instance.pk %}{% url 'usuarios:editar' form.instance.pk %}{% else %}{% url 'usuarios:crear' %}{% endif %}" novalidate>
            {% csrf_token %}

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-person me-2"></i>Datos personales</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombres <span class="text-danger">*</span></label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.first_name.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellidos <span class="text-danger">*</span></label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.last_name.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">C√©dula / Pasaporte</label>
                            {{ form.cedula }}
                            {% if form.cedula.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.cedula.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de nacimiento</label>
                            {{ form.fecha_nacimiento }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tel√©fono</label>
                            {{ form.telefono }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tel√©fono alternativo</label>
                            {{ form.telefono_alt }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">Direcci√≥n</label>
                            {{ form.direccion }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ciudad</label>
                            {{ form.ciudad }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sector / Barrio</label>
                            {{ form.sector }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Foto</label>
                            {{ form.foto }}
                            {% if form.instance.foto %}
                            <div class="mt-2">
                                <img src="{{ form.instance.foto.url }}" style="height:70px;border-radius:4px;border:1px solid var(--gris-borde);">
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-at me-2"></i>Credenciales y acceso</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre de usuario <span class="text-danger">*</span></label>
                            {{ form.username }}
                            {% if form.username.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.username.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Correo electr√≥nico <span class="text-danger">*</span></label>
                            {{ form.email }}
                            {% if form.email.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.email.errors|first }}</div>{% endif %}
                        </div>

                        {# Solo mostrar campos de contrase√±a en creaci√≥n #}
                        {% if not form.instance.pk %}
                        <div class="col-md-6">
                            <label class="form-label">Contrase√±a <span class="text-danger">*</span></label>
                            {{ form.password1 }}
                            {% if form.password1.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.password1.errors|first }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmar contrase√±a <span class="text-danger">*</span></label>
                            {{ form.password2 }}
                            {% if form.password2.errors %}<div style="font-size:.78rem;color:#dc3545;">{{ form.password2.errors|first }}</div>{% endif %}
                        </div>
                        {% else %}
                        <div class="col-12">
                            <div style="background:var(--fondo);border:1px solid var(--gris-borde);border-radius:4px;padding:.65rem 1rem;font-size:.83rem;color:var(--gris-medio);">
                                <i class="bi bi-info-circle me-1"></i>
                                Para cambiar la contrase√±a use el enlace
                                <a href="{% url 'usuarios:cambio-password' %}" style="color:var(--azul-claro);">cambiar contrase√±a</a>.
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header"><i class="bi bi-shield me-2"></i>Rol y estado</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Rol en el sistema <span class="text-danger">*</span></label>
                            {{ form.rol }}
                            <div style="font-size:.75rem;color:var(--gris-medio);margin-top:.3rem;">
                                Define qu√© puede ver y hacer el usuario en el sistema.
                            </div>
                        </div>
                        <div class="col-md-6 d-flex flex-column gap-2 justify-content-end pb-1">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}" style="font-size:.875rem;">
                                    Cuenta activa
                                </label>
                            </div>
                            <div class="form-check">
                                {{ form.is_verified }}
                                <label class="form-check-label" for="{{ form.is_verified.id_for_label }}" style="font-size:.875rem;">
                                    Email verificado
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if form.non_field_errors %}
            <div style="border-left:4px solid #dc3545;background:#f8d7da;color:#842029;padding:.65rem 1rem;border-radius:4px;font-size:.85rem;margin-bottom:1rem;">
                {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
            </div>
            {% endif %}

            <div class="d-flex gap-2 justify-content-end">
                <a href="{% url 'usuarios:lista' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x me-1"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-institucional">
                    <i class="bi bi-check2 me-1"></i>{{ accion|default:"Guardar" }}
                </button>
            </div>
        </form>

        {# ‚îÄ‚îÄ Asignaci√≥n de estudiantes (solo si es representante y ya est√° creado) ‚îÄ‚îÄ #}
        {% if form.instance.pk and form.instance.rol == 'REPRESENTANTE' %}
        <div class="card mt-3" id="seccionEstudiantes">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span><i class="bi bi-people me-2"></i>Estudiantes a cargo</span>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                            data-bs-toggle="collapse" data-bs-target="#panelBuscar">
                        <i class="bi bi-search me-1"></i>Asignar existente
                    </button>
                    <a href="{% url 'estudiantes:crear' %}?representante={{ form.instance.pk }}"
                       class="btn btn-sm btn-institucional">
                        <i class="bi bi-person-plus me-1"></i>Nuevo
                    </a>
                </div>
            </div>

            {# ‚îÄ‚îÄ Panel b√∫squeda por c√©dula ‚îÄ‚îÄ #}
            <div class="collapse" id="panelBuscar">
                <div style="background:#f8f9fa;border-bottom:1px solid var(--gris-borde);padding:.85rem 1rem;">
                    <div style="font-size:.82rem;font-weight:600;color:var(--azul-marino);margin-bottom:.5rem;">
                        <i class="bi bi-search me-1"></i>Buscar estudiante por c√©dula
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="text" id="inputCedula" class="form-control form-control-sm"
                               placeholder="Ingrese la c√©dula del estudiante‚Ä¶"
                               maxlength="13" style="max-width:260px;"
                               onkeydown="if(event.key==='Enter'){event.preventDefault();buscarEstudiante();}">
                        <button type="button" class="btn btn-sm btn-institucional" onclick="buscarEstudiante()">
                            <i class="bi bi-search me-1"></i>Buscar
                        </button>
                    </div>
                    {# Resultado de b√∫squeda #}
                    <div id="resultadoBusqueda" class="mt-2" style="display:none;"></div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Tabla de estudiantes ‚îÄ‚îÄ #}
            <div class="card-body p-0">
                <table style="width:100%;font-size:.875rem;border-collapse:collapse;" id="tablaEstudiantes">
                    <thead>
                        <tr style="background:var(--gris-claro);">
                            <th style="padding:.5rem 1rem;font-weight:600;">Estudiante</th>
                            <th style="padding:.5rem 1rem;font-weight:600;">C√©dula</th>
                            <th style="padding:.5rem 1rem;font-weight:600;">Relaci√≥n</th>
                            <th style="padding:.5rem 1rem;"></th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoEstudiantes">
                        {% for est in form.instance.estudiantes.all %}
                        <tr id="fila-est-{{ est.pk }}" style="border-bottom:1px solid var(--gris-borde);">
                            <td style="padding:.55rem 1rem;font-weight:500;">{{ est.nombre_completo }}</td>
                            <td style="padding:.55rem 1rem;color:var(--gris-medio);">{{ est.cedula|default:"‚Äî" }}</td>
                            <td style="padding:.55rem 1rem;color:var(--gris-medio);">{{ est.relacion_representante }}</td>
                            <td style="padding:.55rem 1rem;text-align:right;">
                                <a href="{% url 'estudiantes:detalle' est.pk %}"
                                   class="btn btn-sm btn-outline-secondary" style="padding:.2rem .5rem;font-size:.75rem;" title="Ver">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'estudiantes:editar' est.pk %}"
                                   class="btn btn-sm btn-outline-secondary ms-1" style="padding:.2rem .5rem;font-size:.75rem;" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" onclick="desasignar({{ est.pk }}, '{{ est.nombre_completo }}')"
                                        class="btn btn-sm btn-outline-danger ms-1" style="padding:.2rem .5rem;font-size:.75rem;" title="Desasignar">
                                    <i class="bi bi-x"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="filaVacia">
                            <td colspan="4" style="padding:1.75rem;text-align:center;color:var(--gris-medio);">
                                <i class="bi bi-person-x d-block mb-1" style="font-size:1.5rem;opacity:.35;"></i>
                                Sin estudiantes asignados. Use los botones de arriba.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <script>
        const REP_PK  = {{ form.instance.pk }};
        const CSRF    = '{{ csrf_token }}';
        const URL_BUSCAR    = "{% url 'usuarios:buscar-estudiante' form.instance.pk %}";
        const URL_ASIGNAR   = "{% url 'usuarios:asignar-estudiante' form.instance.pk %}";
        const URL_DESASIGNAR_BASE = "/usuarios/usuarios/" + REP_PK + "/desasignar/";

        function buscarEstudiante() {
            const cedula = document.getElementById('inputCedula').value.trim();
            const div    = document.getElementById('resultadoBusqueda');
            if (!cedula) return;

            div.style.display = 'block';
            div.innerHTML = '<span style="font-size:.82rem;color:var(--gris-medio);"><i class="bi bi-hourglass-split me-1"></i>Buscando‚Ä¶</span>';

            fetch(URL_BUSCAR + '?cedula=' + encodeURIComponent(cedula))
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        div.innerHTML = `<div style="background:#f8d7da;border-left:3px solid #dc3545;padding:.5rem .75rem;border-radius:0 4px 4px 0;font-size:.82rem;color:#842029;">
                            <i class="bi bi-x-circle me-1"></i>${data.error}</div>`;
                        return;
                    }
                    if (data.ya_asignado) {
                        div.innerHTML = `<div style="background:#d1ecf1;border-left:3px solid #17a2b8;padding:.5rem .75rem;border-radius:0 4px 4px 0;font-size:.82rem;color:#0c5460;">
                            <i class="bi bi-check-circle me-1"></i><strong>${data.nombre}</strong> ya est√° asignado a este representante.</div>`;
                        return;
                    }
                    div.innerHTML = `
                        <div style="background:#d4edda;border-left:3px solid #198754;padding:.6rem .85rem;border-radius:0 4px 4px 0;font-size:.85rem;color:#155724;">
                            <div style="font-weight:600;margin-bottom:.2rem;"><i class="bi bi-person-check me-1"></i>${data.nombre}</div>
                            <div style="font-size:.78rem;">C√©dula: ${data.cedula} &nbsp;|&nbsp; Relaci√≥n actual: ${data.relacion}</div>
                            <button type="button" onclick="asignar(${data.id})"
                                    class="btn btn-sm mt-2" style="background:#198754;color:#fff;font-size:.8rem;">
                                <i class="bi bi-person-plus me-1"></i>Asignar a este representante
                            </button>
                        </div>`;
                })
                .catch(() => {
                    div.innerHTML = '<span style="color:#dc3545;font-size:.82rem;">Error de conexi√≥n.</span>';
                });
        }

        function asignar(estId) {
            fetch(URL_ASIGNAR, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
                body: JSON.stringify({estudiante_id: estId})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                // Quitar fila vac√≠a si existe
                const filaVacia = document.getElementById('filaVacia');
                if (filaVacia) filaVacia.remove();

                // Agregar fila a la tabla
                const tbody = document.getElementById('cuerpoEstudiantes');
                const tr = document.createElement('tr');
                tr.id = 'fila-est-' + data.id;
                tr.style.borderBottom = '1px solid var(--gris-borde)';
                tr.innerHTML = `
                    <td style="padding:.55rem 1rem;font-weight:500;">${data.nombre}</td>
                    <td style="padding:.55rem 1rem;color:var(--gris-medio);">${data.cedula}</td>
                    <td style="padding:.55rem 1rem;color:var(--gris-medio);">${data.relacion}</td>
                    <td style="padding:.55rem 1rem;text-align:right;">
                        <a href="/estudiantes/${data.id}/" class="btn btn-sm btn-outline-secondary" style="padding:.2rem .5rem;font-size:.75rem;"><i class="bi bi-eye"></i></a>
                        <a href="/estudiantes/${data.id}/editar/" class="btn btn-sm btn-outline-secondary ms-1" style="padding:.2rem .5rem;font-size:.75rem;"><i class="bi bi-pencil"></i></a>
                        <button type="button" onclick="desasignar(${data.id}, '${data.nombre}')"
                                class="btn btn-sm btn-outline-danger ms-1" style="padding:.2rem .5rem;font-size:.75rem;"><i class="bi bi-x"></i></button>
                    </td>`;
                tbody.appendChild(tr);

                // Limpiar b√∫squeda
                document.getElementById('inputCedula').value = '';
                document.getElementById('resultadoBusqueda').style.display = 'none';
                document.getElementById('panelBuscar').classList.remove('show');

                // Notificaci√≥n
                const notif = document.createElement('div');
                notif.style.cssText = 'position:fixed;top:1rem;right:1rem;z-index:9999;background:#198754;color:#fff;padding:.6rem 1rem;border-radius:6px;font-size:.875rem;box-shadow:0 3px 12px rgba(0,0,0,.2);';
                notif.innerHTML = `<i class="bi bi-check-circle me-1"></i>${data.nombre} asignado correctamente.`;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3500);
            });
        }

        function desasignar(estId, nombre) {
            if (!confirm(`¬øDesasignar a ${nombre} de este representante?\nEl estudiante quedar√° sin representante asignado.`)) return;
            fetch(URL_DESASIGNAR_BASE + estId + '/', {
                method: 'POST',
                headers: {'X-CSRFToken': CSRF}
            })
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    const fila = document.getElementById('fila-est-' + estId);
                    if (fila) fila.remove();
                    // Si no quedan filas, mostrar vac√≠o
                    const tbody = document.getElementById('cuerpoEstudiantes');
                    if (tbody.querySelectorAll('tr').length === 0) {
                        tbody.innerHTML = `<tr id="filaVacia"><td colspan="4" style="padding:1.75rem;text-align:center;color:var(--gris-medio);">
                            <i class="bi bi-person-x d-block mb-1" style="font-size:1.5rem;opacity:.35;"></i>
                            Sin estudiantes asignados.</td></tr>`;
                    }
                }
            });
        }
        </script>
        {% endif %}
    </div>

    {# Columna lateral: ayuda de roles #}
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-question-circle me-2"></i>Roles del sistema</div>
            <div class="card-body p-0">
                {% for rol, desc, permisos in roles_info %}
                <div style="padding:.85rem 1rem;border-bottom:1px solid var(--gris-borde);">
                    <div style="font-size:.82rem;font-weight:600;color:var(--azul-marino);margin-bottom:.3rem;">
                        {{ rol }}
                    </div>
                    <div style="font-size:.78rem;color:var(--gris-medio);line-height:1.5;">{{ desc }}</div>
                    <ul style="margin:.4rem 0 0;padding-left:1rem;font-size:.76rem;color:#495057;">
                        {% for p in permisos %}
                        <li>{{ p }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% empty %}
                <div style="padding:.85rem 1rem;">
                    <div class="mb-2" style="font-size:.82rem;">
                        <strong style="color:var(--azul-marino);">üõ°Ô∏è Administrador</strong>
                        <div style="font-size:.78rem;color:var(--gris-medio);">Acceso total al sistema</div>
                    </div>
                    <div class="mb-2" style="font-size:.82rem;">
                        <strong style="color:var(--azul-marino);">üìã Secretaria</strong>
                        <div style="font-size:.78rem;color:var(--gris-medio);">Gestiona y aprueba matr√≠culas, ve estudiantes y reportes</div>
                    </div>
                    <div class="mb-2" style="font-size:.82rem;">
                        <strong style="color:var(--azul-marino);">üë®‚Äçüë©‚Äçüë¶ Representante</strong>
                        <div style="font-size:.78rem;color:var(--gris-medio);">Solo puede registrar sus hijos y enviar solicitudes</div>
                    </div>
                    <div style="font-size:.82rem;">
                        <strong style="color:var(--azul-marino);">üìö Docente</strong>
                        <div style="font-size:.78rem;color:var(--gris-medio);">Solo consulta listas de estudiantes de sus paralelos</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>
{% endblock %}